# ATAC Core - Data Models
# このファイルはプロジェクトで使用するすべてのデータモデルを定義します。
# 実装が変更されたら、このファイルも必ず更新してください。

# =============================================================================
# Bot Types
# =============================================================================

BotConfig:
  description: Bot作成時の設定
  fields:
    name: string               # Bot名
    intents: GatewayIntentBits[]  # Discord Intents
    activity: BotActivity?     # アクティビティ設定

BotActivity:
  description: Botのアクティビティ表示
  fields:
    name: string               # アクティビティ名
    type: ActivityType         # アクティビティタイプ

BotStartOptions:
  description: Bot起動時のオプション
  fields:
    token: string              # Discord Bot Token
    client_id: string          # Discord Application Client ID
    guild_id: string?          # Guild ID（指定時はギルドコマンドとして登録）

BotClient:
  description: createBot()が返すBotインスタンス
  methods:
    command: (command: Command) => void
    listener: (listener: Listener) => void
    button: (pattern: string, handler: ButtonHandler) => void
    start: (options: BotStartOptions) => Promise<void>
    destroy: () => Promise<void>
  properties:
    client: Client             # Discord.js Client（読み取り専用）

# =============================================================================
# Command Types
# =============================================================================

Command:
  description: スラッシュコマンド定義
  fields:
    definition: RESTPostAPIChatInputApplicationCommandsJSONBody  # コマンド定義JSON
    execute: (interaction: ChatInputCommandInteraction) => Promise<void>  # 実行関数

ButtonHandler:
  description: ボタンインタラクションハンドラー
  type: (interaction: ButtonInteraction) => Promise<void>

CommandRegistry:
  description: コマンド管理レジストリ
  methods:
    register: (command: Command) => void
    get: (name: string) => Command | undefined
    getDefinitions: () => Command["definition"][]
    deployToGuild: (token: string, client_id: string, guild_id: string) => Promise<void>
    deployGlobal: (token: string, client_id: string) => Promise<void>

ButtonRouter:
  description: ボタンルーティング（customIdプレフィクスマッチ、ワイルドカード*対応）
  methods:
    register: (pattern: string, handler: ButtonHandler) => void
    match: (custom_id: string) => ButtonHandler | undefined

# =============================================================================
# Listener Types
# =============================================================================

Listener:
  description: 型安全なDiscordイベントリスナー
  generic: E extends keyof ClientEvents
  fields:
    event: E                   # イベント名
    execute: (...args: ClientEvents[E]) => Promise<void>  # 実行関数

ListenerRegistry:
  description: リスナー管理レジストリ
  methods:
    register: (listener: Listener) => void
    attachAll: (client: Client) => void

# =============================================================================
# Interaction Types
# =============================================================================

ReplyBuilder:
  description: Discord応答ビルダー（fluent API）
  methods:
    from: (interaction: ChatInputCommandInteraction) => ReplyBuilder  # static
    ephemeral: () => ReplyBuilder
    content: (text: string) => ReplyBuilder
    embed: (builder_fn: (embed: EmbedBuilder) => EmbedBuilder) => ReplyBuilder
    addEmbed: (embed: EmbedBuilder) => ReplyBuilder
    buttons: (builder_fn: (row: ButtonRowBuilder) => ButtonRowBuilder) => ReplyBuilder
    send: () => Promise<void>
    defer: () => Promise<void>
    followUp: () => Promise<void>

ButtonRowBuilder:
  description: ボタン行ビルダー
  methods:
    confirm: (custom_id: string, label: string) => ButtonRowBuilder
    cancel: (custom_id: string, label: string) => ButtonRowBuilder
    primary: (custom_id: string, label: string) => ButtonRowBuilder
    secondary: (custom_id: string, label: string) => ButtonRowBuilder
    link: (url: string, label: string) => ButtonRowBuilder
    build: () => ActionRowBuilder<ButtonBuilder>

EmbedHelper:
  description: Embed生成ヘルパー
  static_methods:
    info: (title: string, description: string) => EmbedBuilder
    error: (title: string, description: string) => EmbedBuilder
    warning: (title: string, description: string) => EmbedBuilder
    success: (title: string, description: string) => EmbedBuilder
    create: () => EmbedHelper
  methods:
    setTitle: (title: string) => EmbedHelper
    setDescription: (description: string) => EmbedHelper
    setColor: (color: number) => EmbedHelper
    addField: (name: string, value: string, inline?: boolean) => EmbedHelper
    setFooter: (text: string) => EmbedHelper
    setThumbnail: (url: string) => EmbedHelper
    setImage: (url: string) => EmbedHelper
    setTimestamp: () => EmbedHelper
    build: () => EmbedBuilder

PollBuilder:
  description: アンケート/投票ビルダー（ボタンベース）
  constructor: (question: string)
  methods:
    option: (custom_id: string, label: string) => PollBuilder
    getQuestion: () => string
    build: () => ActionRowBuilder<ButtonBuilder>[]

# =============================================================================
# Voice Types
# =============================================================================

VoiceRecorderConfig:
  description: 録音設定
  fields:
    recordings_dir: string     # 録音保存ディレクトリ
    after_silence_ms: number   # 無音タイムアウト（ミリ秒）
    segment_seconds: number    # セグメント長（秒）

RecordingSession:
  description: 録音セッション結果
  fields:
    session_id: string         # セッションID
    session_dir: string        # セッションディレクトリパス
    segments: RecordingSegment[]  # セグメント配列
    participants_path: string  # participants.jsonパス
    started_at: Date           # 開始時刻
    stopped_at: Date           # 停止時刻

RecordingSegment:
  description: 録音セグメント
  fields:
    file_path: string          # ファイルパス
    user_id: string            # ユーザーID
    username: string           # ユーザー名
    started_at: number         # 開始タイムスタンプ（ms）
    duration_ms: number        # 長さ（ミリ秒）

ParticipantInfo:
  description: 参加者情報
  fields:
    user_id: string            # ユーザーID
    username: string           # ユーザー名
    joined_at: string          # 参加時刻（ISO 8601）

VoiceRecorder:
  description: 通話録音基盤
  constructor: (config: VoiceRecorderConfig)
  methods:
    join: (member: GuildMember) => Promise<void>
    start: () => Promise<void>
    stop: () => Promise<RecordingSession>
    leave: () => Promise<void>
  static_methods:
    cleanupOldSessions: (recordings_dir: string, max_age_days: number) => Promise<number>

# =============================================================================
# Environment
# =============================================================================

loadEnvironment:
  description: Zod環境変数ローダー（dotenvを読み込みZodスキーマでバリデーション）
  signature: <T>(schema: z.ZodObject<T>) => z.infer<z.ZodObject<T>>

# =============================================================================
# Error Types
# =============================================================================

ATACError:
  description: ATACカスタムエラー
  extends: Error
  fields:
    code: string               # エラーコード
    details: Record<string, unknown>  # 詳細情報

ErrorCode:
  description: エラーコード一覧
  values:
    # Bot errors
    - BOT_ALREADY_STARTED
    - BOT_NOT_STARTED
    - BOT_START_FAILED
    # Command errors
    - COMMAND_NOT_FOUND
    - COMMAND_EXECUTION_FAILED
    - COMMAND_REGISTER_FAILED
    # Button errors
    - BUTTON_HANDLER_NOT_FOUND
    - BUTTON_EXECUTION_FAILED
    # Listener errors
    - LISTENER_EXECUTION_FAILED
    # Environment errors
    - ENV_VALIDATION_FAILED
    - ENV_LOAD_FAILED
    # Reply errors
    - REPLY_ALREADY_SENT
    - REPLY_SEND_FAILED
    # Voice errors
    - VOICE_JOIN_FAILED
    - VOICE_LEAVE_FAILED
    - VOICE_NOT_CONNECTED
    - VOICE_ALREADY_RECORDING
    - VOICE_NOT_RECORDING
    - VOICE_RECORDING_FAILED
    - VOICE_CLEANUP_FAILED

# =============================================================================
# Logger
# =============================================================================

Logger:
  description: 構造化ログ出力
  constructor: (name: string)
  methods:
    debug: (message_key: string, meta?: Record<string, unknown>) => void
    info: (message_key: string, meta?: Record<string, unknown>) => void
    warn: (message_key: string, meta?: Record<string, unknown>) => void
    error: (message_key: string, meta?: Record<string, unknown>) => void

LogMessages:
  description: ログメッセージ一覧
  values:
    - BOT_STARTING
    - BOT_READY
    - BOT_STOPPED
    - COMMAND_REGISTERED
    - COMMAND_EXECUTED
    - BUTTON_EXECUTED
    - LISTENER_TRIGGERED
    - VOICE_JOINED
    - VOICE_LEFT
    - VOICE_RECORDING_STARTED
    - VOICE_RECORDING_STOPPED
    - VOICE_SEGMENT_SAVED
    - VOICE_CLEANUP_COMPLETED
    - ENV_LOADED
    - SIGNAL_RECEIVED

# =============================================================================
# Environment Variables
# =============================================================================

EnvironmentVariables:
  description: 必要な環境変数一覧
  variables:
    DISCORD_TOKEN: string        # Discord Bot Token（必須）
    DISCORD_CLIENT_ID: string    # Discord Application Client ID（必須）
    DISCORD_GUILD_ID: string?    # 開発用Guild ID（任意）
